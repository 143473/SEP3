@page "/ManageAccount"

@using Presentation_Layer.Authentication
@using System.Security.Claims
@using global::Data
@using Presentation_Layer.Models

@inject IUserService UserService
@inject AuthenticationStateProvider StateProvider
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<h3>Manage Account</h3>
@if (user == null)
{
    <p>Loading...</p>
}
else
{
    <h3>@username</h3>
    <h3>@user.Username</h3>
    @if (user.FirstName != null && user.LastName != null)
    {
        <p>Name: @(user.FirstName ?? "") @(user.LastName ?? "")</p>
    }
    <p>Role: @(user.Role == 3 ? "Organizer" : "Player")</p>
    @if (user.PhoneNumber != null)
    {
        <p>Phone: @(user.PhoneCountryCode ?? "") @user.PhoneNumber</p>
    }
    @if (user.EmailAddress != null)
    {
        <p>Email: @user.EmailAddress</p>
    }
    <p class="actions">
        <button class="btn btn-outline-info" type="submit" @onclick="@Edit">Save</button>
    </p>

    <p class="actions">
        <button class="btn btn-outline-danger" type="submit" @onclick="@DeleteAccountAsync">Delete account</button>
    </p>
}

<AuthorizeView Policy="Player">
    <p class="actions">
        
        <button class="btn btn-outline-primary" type="submit" @onclick="@RequestForOrganizerAsync">Request for organizer</button>
    </p>
    <p>@confirmationMessage</p>
</AuthorizeView>



@code {
    private bool request;
    private string username;
    private string confirmationMessage;
    private User user;

    protected override async Task OnInitializedAsync()
    {
        username = ((CustomAuthenticationStateProvider) StateProvider).GetAuthenticationStateAsync().Result.User.FindFirst(claim => claim.Type.Equals(ClaimTypes.Name))?.Value;
        Console.WriteLine(username);
        user = await UserService.GetUserByUsernameAsync(username);
    }
    
    private async Task RequestForOrganizerAsync()
    {
        request = true;
        await UserService.RequestPromotionToOrganizer();
        confirmationMessage = "Request for organizer sent successfully.";
    }

    private async Task DeleteAccountAsync()
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm","Are you sure you want to delete your account?"))
            return;
        await UserService.DeleteAccountAsync(username);
        await ((CustomAuthenticationStateProvider) StateProvider).Logout();
        NavigationManager.NavigateTo("/");
    }

    private void Edit()
    {
        NavigationManager.NavigateTo($"/EditAccount/{username}");
    }

}
